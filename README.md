# spGET_ErrorMessage
Procedure to retrieve the last error message on an SQL Server. [archival]

This is an old project of mine, that I created back in 2008.<br/>
Imported into GitHub for archival puposes only.<br/>
There will be no updates.

<h2>Introduction</h2><p>Recently I was given the task at work to migrate the invoice data from the old database to the new one due to the new ERP software the company I work&nbsp;for is installing, and I was requested to do it solely&nbsp;with T-SQL&nbsp;procedures.</p><p>Due the nature of the data and the ERP software the invoices need to be imported one at a time, and I need to keep a log of any invoice that, for some reason, could not be migrated.</p><p>The company currently uses SQL Server 2000, and as such it has poorly error management in T-SQL, at best we can use the <a href="http://msdn2.microsoft.com/en-us/library/aa933181(SQL.80).aspx"><code>@@error</code></a> global variable.</p><p>Searching the net I found a <a href="http://www.sommarskog.se/error-handling-I.html">website</a> that offered some way to retrieve the complete error message, and I simply dig into the problem a little bit further, because on my tests&nbsp;the method on that site didn't quite worked.</p><p>The method consists in dumping the current output buffer, using <code><a href="http://msdn2.microsoft.com/en-us/library/aa258810(SQL.80).aspx">DBCC OUTPUTBUFFER</a>(<a href="mailto:s@@spid">@@spid</a>)</code>, and search through the buffer to find the error message.</p><p>The procedure that I found on that website, used a fixed approach, and broke when searching for the message outside the point where it thought it should be.</p><p>Using that procedure as an inspiration I devised a new way to retrieve the error message.</p><p>I must warn that this method of acquiring the error message uses an UNDOCUMENTED resource, and thus if you use it, you are on your own. One other thing, the use of <code>DBCC OUTPUTBUFFER</code> requires&nbsp;admin level&nbsp;permission, this way, I can't stress enough that you do not use this code in production environment.</p><p>Take the following test code:</p><pre class="sql">raiserror ('TEST 01', 16, 1)&#13;raiserror ('TEST 02', 17, 2)&#13;raiserror ('TEST 03', 18, 3)&#13;go&#13;&#13;dbcc outputbuffer(@@spid)&#13;</pre><p>On my SQL Server&nbsp;the buffer has the following data:&nbsp;</p><pre>00000000   04 01 00 c8 00 37 01 00 <b>aa</b> 30 00 50 c3 00 00 01&#13;00000010   10 07 00 54 00 45 00 53 00 54 00 20 00 30 00 31&#13;00000020   00 0a 45 00 4e 00 54 00 45 00 52 00 50 00 52 00&#13;00000030   49 00 53 00 45 00 00 01 00 00 00 fd 03 00 f6 00&#13;00000040   00 00 00 00 00 00 00 00 <b>aa</b> 30 00 50 c3 00 00 02&#13;00000050   11 07 00 54 00 45 00 53 00 54 00 20 00 30 00 32&#13;00000060   00 0a 45 00 4e 00 54 00 45 00 52 00 50 00 52 00&#13;00000070   49 00 53 00 45 00 00 02 00 00 00 fd 03 00 f6 00&#13;00000080   00 00 00 00 00 00 00 00 <b>aa</b> 30 00 50 c3 00 00 03&#13;00000090   12 07 00 54 00 45 00 53 00 54 00 20 00 30 00 33&#13;000000a0   00 0a 45 00 4e 00 54 00 45 00 52 00 50 00 52 00&#13;000000b0   49 00 53 00 45 00 00 03 00 00 00 fd 02 00 f6 00&#13;000000c0   00 00 00 00 00 00 00 00 30 00 20 00 36 00 64 00</pre><p>Examining the buffer I figured that&nbsp;an error message starts after an 0xAA byte (in bold), after it has the following structure:</p><ul><li>Size of the entire error message (2 bytes)</li><li>Error Number (4 bytes)</li><li>Error State (1 byte)</li><li>Error Level (1 byte)</li><li>Size of the text, in character,&nbsp;of the error message (2 bytes)</li><li>Variable length of bytes with the Unicode error message</li><li>Size of the name of SQL Server instance (1 byte)</li><li>Variable length of bytes with the Unicode name of the SQL Server instance</li><li>Size of the name of the stored procedure where the error occurred (1 byte)</li><li>Variable length of bytes with the Unicode name stored procedure</li><li>Line where the error occurred (2 bytes)</li></ul><p>All multi-byte numbers are in <a href="http://en.wikipedia.org/wiki/Big-endian">little-endian</a> formatting.</p><p>The procedure in the file above returns a table with the following information:</p><ul><li>Error Number</li><li>Error State</li><li>Error Level</li><li>Error Message</li><li>Instance Name</li><li>Procedure Name</li><li>Line </li></ul><p>Please, download the code and try it out.</p>

